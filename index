<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TI-30XS Student View - Final Prototype</title>
    
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fraction.js@4.1.1/dist/fraction.min.js"></script>

    <style>
        :root {
            --bg-color: #1a1a1a;
            --calc-body: #3c3c3c;
            --screen-bg: #aebbaf;
            --btn-live: #555;
            --btn-ghost: #2b2b2b;
            --highlight: #ffff00;
        }

        body { background: var(--bg-color); display: flex; justify-content: center; font-family: 'Segoe UI', sans-serif; padding-top: 20px; }
        .calc-container { background: var(--calc-body); width: 380px; padding: 25px; border-radius: 25px; border: 6px solid #555; box-shadow: 0 20px 50px rgba(0,0,0,0.6); }

        .screen-container { position: relative; background: var(--screen-bg); height: 110px; margin-bottom: 25px; border: 4px inset #888; padding: 10px; box-shadow: inset 0 2px 10px rgba(0,0,0,0.2); }
        #second-indicator { position: absolute; top: 5px; left: 10px; font-size: 12px; font-weight: bold; color: #222; opacity: 0.1; }
        #second-indicator.active { opacity: 1; }
        #display-area { height: 100%; width: 100%; display: flex; align-items: center; justify-content: flex-end; font-size: 28px; color: #222; overflow: hidden; }

        .keypad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        button { height: 48px; border-radius: 8px; border: none; font-weight: bold; font-size: 13px; color: #666; background: var(--btn-ghost); pointer-events: none; }
        .live { background: var(--btn-live); color: white; box-shadow: 0 3px #222; }
        .blue { background: #4a90e2 !important; }
        .green { background: #50b347 !important; }
        .red { background: #e74c3c !important; }
        .highlight { background-color: var(--highlight) !important; color: #000 !important; box-shadow: 0 0 25px var(--highlight); transform: scale(1.15); z-index: 10; }
        .label-top { font-size: 10px; text-align: center; margin-bottom: 10px; color: #888; text-transform: uppercase; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div class="calc-container">
        <div class="label-top">TI-30XS MultiView - Classroom Mode</div>
        <div class="screen-container">
            <div id="second-indicator">2ND</div>
            <div id="display-area">\( 0 \)</div>
        </div>
        <div class="keypad">
            <button id="btn-2nd" class="live green">2nd</button><button class="ghost">mode</button><button class="ghost">del</button><button id="btn-clear" class="live red">clear</button><button class="ghost">on</button>
            <button class="ghost">yˣ</button><button id="btn-sqrt" class="live">√</button><button id="btn-sq" class="live">x²</button><button class="ghost">^</button><button class="ghost">log</button>
            <button id="btn-nd" class="live blue">n/d</button><button class="ghost">sin</button><button class="ghost">cos</button><button class="ghost">tan</button><button class="ghost">π</button>
            <button id="btn-7" class="live">7</button><button id="btn-8" class="live">8</button><button id="btn-9" class="live">9</button><button id="btn-div" class="live">÷</button><button class="ghost">%</button>
            <button id="btn-4" class="live">4</button><button id="btn-5" class="live">5</button><button id="btn-6" class="live">6</button><button id="btn-mul" class="live">×</button><button class="ghost">(</button>
            <button id="btn-1" class="live">1</button><button id="btn-2" class="live">2</button><button id="btn-3" class="live">3</button><button id="btn-sub" class="live">−</button><button class="ghost">)</button>
            <button id="btn-0" class="live">0</button><button id="btn-dot" class="live">.</button><button id="btn-toggle" class="live blue">f◄►d</button><button id="btn-add" class="live">+</button><button id="btn-enter" class="live green">enter</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Ably to be available
            if (typeof Ably === 'undefined') return;

            const ably = new Ably.Realtime('pHT1jg.eDekmw:okoPfOKG25Z6WVOm7peHjkK3BF_kNw7sy0O0cRtVVVE');
            const channel = ably.channels.get('ged-calculator');
            
            let displayString = "0"; 
            let evalString = "";    
            let isSecondActive = false;
            let isFractionMode = false;
            let fractionNum = "";
            let fractionDen = "";
            let activePart = "num"; // 'num' or 'den'

            channel.subscribe('keypress', (msg) => {
                const key = msg.data.key;
                const btn = document.getElementById(`btn-${key}`);
                const indicator = document.getElementById('second-indicator');

                if (btn) {
                    btn.classList.add('highlight');
                    setTimeout(() => btn.classList.remove('highlight'), 1000);
                }

                if (key === '2nd') {
                    isSecondActive = !isSecondActive;
                    indicator.className = isSecondActive ? 'active' : '';
                    return;
                }

                if (key === 'clear') {
                    resetCalc();
                } else if (key === 'nd') {
                    isFractionMode = true; activePart = "num";
                } else if (key === 'down' && isFractionMode) {
                    activePart = "den";
                } else if (key === 'up' && isFractionMode) {
                    activePart = "num";
                } else if (key === 'toggle') {
                    handleToggle();
                } else if (key === 'enter') {
                    calculate();
                } else if (key === 'sqrt') {
                    evalString += "Math.sqrt(";
                    displayString = "\\sqrt{";
                } else if (key === 'sq') {
                    evalString = `Math.pow(${evalString}, 2)`;
                    displayString += "^2";
                } else {
                    handleInput(key);
                }
                render();
            });

            function handleInput(key) {
                const map = { 'add': '+', 'sub': '-',
