<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TI-30XS - Repair Build</title>
    
    <script src="ably.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fraction.js@4.1.1/dist/fraction.min.js"></script>

    <style>
        :root { --bg: #1a1a1a; --calc: #3c3c3c; --lcd: #aebbaf; --high: #ffff00; }
        body { background: var(--bg); display: flex; justify-content: center; font-family: sans-serif; padding-top: 20px; }
        .calc-container { background: var(--calc); width: 380px; padding: 25px; border-radius: 25px; border: 6px solid #555; }
        .screen-container { background: var(--lcd); height: 110px; margin-bottom: 25px; border: 4px inset #888; padding: 10px; display: flex; align-items: center; justify-content: flex-end; }
        #display-area { font-size: 32px; color: #222; }
        .keypad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        button { height: 48px; border-radius: 8px; border: none; font-weight: bold; background: #2b2b2b; color: #666; pointer-events: none; }
        .live { background: #555; color: white; }
        .highlight { background-color: var(--high) !important; color: #000 !important; transform: scale(1.1); }
    </style>
</head>
<body>

    <div class="calc-container">
        <div class="screen-container">
            <div id="display-area">\( 0 \)</div>
        </div>
        <div class="keypad">
            <button id="btn-2nd" class="live">2nd</button><button>mode</button><button>del</button><button id="btn-clear" class="live">clear</button><button>on</button>
            <button>yˣ</button><button id="btn-sqrt" class="live">√</button><button id="btn-sq" class="live">x²</button><button>^</button><button>log</button>
            <button id="btn-nd" class="live">n/d</button><button>sin</button><button>cos</button><button>tan</button><button>π</button>
            <button id="btn-7" class="live">7</button><button id="btn-8" class="live">8</button><button id="btn-9" class="live">9</button><button id="btn-div" class="live">÷</button><button>%</button>
            <button id="btn-4" class="live">4</button><button id="btn-5" class="live">5</button><button id="btn-6" class="live">6</button><button id="btn-mul" class="live">×</button><button>(</button>
            <button id="btn-1" class="live">1</button><button id="btn-2" class="live">2</button><button id="btn-3" class="live">3</button><button id="btn-sub" class="live">−</button><button>)</button>
            <button id="btn-0" class="live">0</button><button id="btn-dot" class="live">.</button><button id="btn-toggle" class="live">f◄►d</button><button id="btn-add" class="live">+</button><button id="btn-enter" class="live">enter</button>
        </div>
    </div>

    <script>
        // GLOBAL STATE
        let displayString = "0"; 
        let evalString = "";    
        let currentMathValue = null;

        window.onload = function() {
            const screen = document.getElementById('display-area');

            // Force initial render
            MathJax.typeset();

            if (typeof Ably === 'undefined') { screen.innerHTML = "Check ably.js"; return; }

            const ably = new Ably.Realtime('pHT1jg.eDekmw:okoPfOKG25Z6WVOm7peHjkK3BF_kNw7sy0O0cRtVVVE');
            const channel = ably.channels.get('ged-calculator');

            channel.subscribe('keypress', (msg) => {
                const key = msg.data.key;
                
                // Visual Highlight
                const btn = document.getElementById(`btn-${key}`);
                if (btn) {
                    btn.classList.add('highlight');
                    setTimeout(() => btn.classList.remove('highlight'), 500);
                }

                if (key === 'clear') {
                    displayString = "0"; evalString = "";
                } else if (key === 'enter') {
                    try {
                        let res = eval(evalString);
                        currentMathValue = new Fraction(res);
                        displayString = currentMathValue.d === 1 ? currentMathValue.n.toString() : `\\frac{${currentMathValue.n}}{${currentMathValue.d}}`;
                        evalString = res.toString();
                    } catch(e) { displayString = "Error"; }
                } else {
                    const map = { 'add': '+', 'sub': '-', 'mul': '*', 'div': '/' };
                    let val = map[key] || key;
                    if (displayString === "0") { displayString = ""; evalString = ""; }
                    displayString += val;
                    evalString += val;
                }

                // THE CRITICAL FIX: Direct update and immediate re-typeset
                screen.innerHTML = `\\( ${displayString} \\)`;
                MathJax.typeset(); 
            });
        };
    </script>
</body>
</html>
