<script>
window.onload = function() {
    // 1. SAFETY CHECK: If Ably didn't load, stop and show error
    if (typeof Ably === 'undefined') {
        console.error("âŒ Ably Library failed to load from CDN.");
        document.getElementById('display-area').innerHTML = "Connection Error";
        return;
    }

    // 2. GLOBAL STATE
    let displayString = "0"; 
    let evalString = "";    
    let isFractionMode = false;
    let fractionNum = "";
    let fractionDen = "";
    let activePart = "num"; 
    let isSecondActive = false;
    let currentMathValue = null;

    // 3. ABLY INITIALIZATION
    const ably = new Ably.Realtime('pHT1jg.eDekmw:okoPfOKG25Z6WVOm7peHjkK3BF_kNw7sy0O0cRtVVVE');
    const channel = ably.channels.get('ged-calculator');

    ably.connection.on('connected', () => {
        console.log("âœ… ABLY CONNECTED: Ready for remote signals.");
    });

    channel.subscribe('keypress', (msg) => {
        console.log("ðŸ“¥ KEY RECEIVED:", msg.data.key);
        handleKey(msg.data.key);
    });

    // 4. LOGIC CONTROLLER
    function handleKey(key) {
        const btn = document.getElementById(`btn-${key}`);
        const indicator = document.getElementById('second-indicator');

        if (btn) {
            btn.classList.add('highlight');
            setTimeout(() => btn.classList.remove('highlight'), 1000);
        }

        if (key === '2nd') {
            isSecondActive = !isSecondActive;
            indicator.classList.toggle('active', isSecondActive);
            return;
        }

        if (key === 'clear') {
            resetCalc();
        } else if (key === 'nd') {
            isFractionMode = true; activePart = "num";
        } else if (key === 'down' || key === 'right') {
            if (isFractionMode && activePart === "num") activePart = "den";
            else if (isFractionMode && activePart === "den") activePart = "outside";
        } else if (key === 'up' || key === 'left') {
            if (isFractionMode && activePart === "outside") activePart = "den";
            else if (isFractionMode && activePart === "den") activePart = "num";
        } else if (key === 'enter') {
            calculate();
        } else if (key === 'toggle') {
            toggleFormat();
        } else if (key === 'sqrt') {
            evalString += "Math.sqrt(";
            displayString = "\\sqrt{";
        } else if (key === 'sq') {
            evalString = `Math.pow(${evalString || 0}, 2)`;
            displayString += "^2";
        } else {
            handleInput(key);
        }

        if (key !== '2nd' && isSecondActive) {
            isSecondActive = false;
            indicator.classList.remove('active');
        }
        render();
    }

    function handleInput(key) {
        const map = { 'add': '+', 'sub': '-', 'mul': '*', 'div': '/' };
        let val = map[key] || key;

        if (isFractionMode && activePart !== "outside") {
            if (activePart === "num") fractionNum += val;
            else fractionDen += val;
        } else {
            if (displayString === "0") { displayString = ""; evalString = ""; }
            displayString += (map[key] ? ` ${val} ` : val);
            evalString += val;
        }
    }

    function calculate() {
        try {
            let finalExpr = isFractionMode ? `(${fractionNum || 0})/(${fractionDen || 1})` : evalString;
            let numericResult = eval(finalExpr);
            currentMathValue = new Fraction(numericResult);
            
            if (currentMathValue.d === 1) {
                displayString = currentMathValue.n.toString();
            } else {
                displayString = `\\frac{${currentMathValue.n}}{${currentMathValue.d}}`;
            }
            evalString = numericResult.toString();
            isFractionMode = false;
            fractionNum = ""; fractionDen = "";
        } catch (e) {
            displayString = "\\text{Error}";
        }
    }

    function toggleFormat() {
        if (!currentMathValue) return;
        if (displayString.includes('frac')) {
            displayString = (currentMathValue.n / currentMathValue.d).toString();
        } else {
            displayString = `\\frac{${currentMathValue.n}}{${currentMathValue.d}}`;
        }
    }

    function resetCalc() {
        displayString = "0"; evalString = ""; isFractionMode = false;
        fractionNum = ""; fractionDen = ""; currentMathValue = null;
        document.getElementById('second-indicator').classList.remove('active');
    }

    function render() {
        let output = displayString;
        if (isFractionMode) {
            let n = fractionNum || "\\square";
            let d = fractionDen || "\\square";
            if (activePart === "num") n = `\\color{blue}{${n}}`;
            else if (activePart === "den") d = `\\color{blue}{${d}}`;
            output = `\\frac{${n}}{${d}}`;
            if (activePart === "outside") output += "\\color{blue}{|}";
        }
        document.getElementById('display-area').innerHTML = `\\( ${output} \\)`;
        if (window.MathJax) MathJax.typeset();
    }
};
</script>
